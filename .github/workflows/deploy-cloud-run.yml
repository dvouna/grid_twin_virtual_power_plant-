name: Deploy to Cloud Run

on:
  push:
    branches: [ "main", "develop" ]

env:
  REGION: us-central1
  GCP_PROJECT_ID: igneous-study-486512-g4
  REDPANDA_VM_NAME: redpanda-connect-vm
  REDPANDA_VM_ZONE: us-central1-a
  WIF_PROVIDER_NAME: projects/207186852167/locations/global/workloadIdentityPools/vpp-provider/providers/github-provider
  GCP_SERVICE_ACCOUNT: vpp-mcp-sa@igneous-study-486512-g4.iam.gserviceaccount.com

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff pytest # Ensure test tools are installed

      - name: Run Ruff Linter
        run: ruff check src/ tests/ --output-format=github

      - name: Run Pytest
        env:
          PYTHONPATH: src
        run: pytest -m "not integration" -v

  deploy-staging:
    name: Deploy to Staging
    needs: test
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    environment: staging
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WIF_PROVIDER_NAME }}'
          service_account: '${{ env.GCP_SERVICE_ACCOUNT }}'

      - name: Deploy to Cloud Run (Staging)
        id: deploy
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: vpp-mcp-server-stage
          region: ${{ env.REGION }}
          source: .
          timeout: '300s'
          flags: >
            --memory=1Gi 
            --cpu-boost 
            --startup-probe=httpGet.path=/health,httpGet.port=8080,initialDelaySeconds=10,periodSeconds=5,failureThreshold=3 
            --no-allow-unauthenticated
          secrets: |-
            INFLUX_CLOUD_URL=INFLUX_CLOUD_URL:latest
            INFLUX_CLOUD_TOKEN=INFLUX_CLOUD_TOKEN:latest
            INFLUX_CLOUD_ORG=INFLUX_CLOUD_ORG:latest
            INFLUX_CLOUD_BUCKET=INFLUX_CLOUD_BUCKET:latest
          env_vars: |-
            MCP_TRANSPORT=sse

      - name: Run Staging Health Check
        run: |
          echo "Waiting for staging deployment to be ready..."
          sleep 30
          echo "Staging deployment successful"

      - name: Create Deployment Summary
        if: success()
        run: |
          echo "## Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.job }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Service Logs](https://console.cloud.google.com/run/detail/${{ env.REGION }}/vpp-mcp-server-stage/logs?project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Redpanda Connect VM](https://console.cloud.google.com/compute/instancesDetail/zones/${{ env.REDPANDA_VM_ZONE }}/instances/${{ env.REDPANDA_VM_NAME }}?project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: Deploy to Production
    needs: [test, deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment: production
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ env.WIF_PROVIDER_NAME }}'
          service_account: '${{ env.GCP_SERVICE_ACCOUNT }}'

      - name: Deploy to Cloud Run (Production)
        id: deploy
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: vpp-mcp-server
          region: ${{ env.REGION }}
          source: .
          timeout: '300s'
          flags: >
            --memory=1Gi 
            --cpu-boost 
            --startup-probe=httpGet.path=/health,httpGet.port=8080,initialDelaySeconds=10,periodSeconds=5,failureThreshold=3 
            --no-allow-unauthenticated
          secrets: |-
            INFLUX_CLOUD_URL=INFLUX_CLOUD_URL:latest
            INFLUX_CLOUD_TOKEN=INFLUX_CLOUD_TOKEN:latest
            INFLUX_CLOUD_ORG=INFLUX_CLOUD_ORG:latest
            INFLUX_CLOUD_BUCKET=INFLUX_CLOUD_BUCKET:latest
          env_vars: |-
            MCP_TRANSPORT=sse

      - name: Production Deployment Complete
        run: |
          echo "Production deployment successful"
          echo "Service URL: https://vpp-mcp-server-${{ env.REGION }}.run.app"

      - name: Create Deployment Summary
        if: success()
        run: |
          echo "## Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ steps.deploy.outputs.url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.job }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Service Logs](https://console.cloud.google.com/run/detail/${{ env.REGION }}/vpp-mcp-server/logs?project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Redpanda Connect VM](https://console.cloud.google.com/compute/instancesDetail/zones/${{ env.REDPANDA_VM_ZONE }}/instances/${{ env.REDPANDA_VM_NAME }}?project=${{ env.GCP_PROJECT_ID }})" >> $GITHUB_STEP_SUMMARY